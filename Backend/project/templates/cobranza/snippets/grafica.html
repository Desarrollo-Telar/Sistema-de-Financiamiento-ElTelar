{% load static %}
<div class="chart-container">
    <h4>üìä Registros de Cobranza</h4>
    <canvas id="myChartCobranza"></canvas>
    <input type="hidden" value="{{user_code}}" id="user_code">
</div>
<div class="widget-container">
    <div class="widget-header">
        <div class="icon">üí≥</div>
        <div>
            <div class="widget-title">Gesti√≥n de Cobranza</div>
        </div>
    </div>

    <div class="stats-container">
        <div class="stat-item">
            <span class="stat-label">Gestiones Realizadas</span>
            <span class="stat-value completed" id="completed-count">15</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Cr√©ditos Pendientes</span>
            <span class="stat-value pending" id="pending-count">8</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Total de Cr√©ditos</span>
            <span class="stat-value" id="total-count">23</span>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <div class="d-flex">
        <button class="btn_cancel" onclick="openModal()" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Creditos Restantes"
                data-bs-original-title="Creditos Restantes">
            Ver Cr√©ditos Restantes
        </button>
        <button class="btn_cancel" onclick="openModalVigentes()" data-bs-toggle="tooltip" data-bs-placement="right" aria-label="Creditos Restantes"
                data-bs-original-title="Creditos Vigentes">
            Ver Cr√©ditos Vigentes
        </button>
    </div>

</div>

<!-- Modal -->
{% include 'cobranza/snippets/modal_cobranza.html' %}

<script>
    // Variable global de datos
    const creditosData = {
        completed: 0,
        pending: 0,
        total: 0,
        pendingCredits: [],
        currentLoans: [],
    };

    // Inicializar el widget al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function () {
        // Obt√©n el user_code desde tu contexto Django
        const userCode = "{{ user_code }}";
        const apiUrl = `/customers/asesores_credito/api/${userCode}/`;

        // Mostrar estado de carga
        showLoadingState();

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Actualizamos el widget con los datos de la API
                actualizarDatos(
                    data.total_realizados,
                    data.total_faltantes,
                    data.total_creditos,
                    data.creditos_faltantes.map(c => ({
                        name: `${c.customer_id.first_name} ${c.customer_id.last_name}`,
                        amount: `${parseFloat(c.saldo_actual).toLocaleString()}`,
                        details: `Vencimiento: ${c.fecha_vencimiento}`,
                        id: c.codigo_credito,
                        _id: c.id
                    })),
                    data.creditos_vigentes.map(c => ({
                        name: `${c.customer_id.first_name} ${c.customer_id.last_name}`,
                        amount: `${parseFloat(c.saldo_actual).toLocaleString()}`,
                        details: `Vencimiento: ${c.fecha_vencimiento}`,
                        id: c.codigo_credito,
                        _id: c.id
                    }))
                );
                hideLoadingState();
            })
            .catch(error => {
                console.error("Error al cargar datos de la API:", error);
                showErrorState(error.message);
            });
    });

    function showLoadingState() {
        document.getElementById('completed-count').textContent = '...';
        document.getElementById('pending-count').textContent = '...';
        document.getElementById('total-count').textContent = '...';
        document.getElementById('progress-fill').style.width = '0%';
    }

    function hideLoadingState() {
        // Se ocultar√° autom√°ticamente cuando se actualicen los datos
    }

    function showErrorState(errorMessage) {
        document.getElementById('completed-count').textContent = 'Error';
        document.getElementById('pending-count').textContent = 'Error';
        document.getElementById('total-count').textContent = 'Error';

        // Opcional: mostrar mensaje de error al usuario
        console.warn('No se pudieron cargar los datos:', errorMessage);
    }

    function updateWidgetData() {
        document.getElementById('completed-count').textContent = creditosData.completed;
        document.getElementById('pending-count').textContent = creditosData.pending;
        document.getElementById('total-count').textContent = creditosData.total;

        // Actualizar barra de progreso
        const progressPercentage = creditosData.total > 0 ? (creditosData.completed / creditosData.total) * 100 : 0;
        document.getElementById('progress-fill').style.width = progressPercentage + '%';
    }

    function loadPendingCredits() {
        const pendingList = document.getElementById('credits-list-pendientes');
        const vigenteList = document.getElementById('credits-list-vigentes');
        pendingList.innerHTML = '';
        vigenteList.innerHTML = '';

        // Cr√©ditos pendientes
        if (creditosData.pendingCredits.length === 0) {
            pendingList.innerHTML = '<div class="credit-item" style="text-align: center; color: #6c757d;">No hay cr√©ditos pendientes</div>';
        } else {
            creditosData.pendingCredits.forEach(credit => {
                const creditItem = document.createElement('div');
                creditItem.className = 'credit-item';
                creditItem.innerHTML = `
            <a href='/financings/credit/${credit._id}/' style='text-decoration:none;'> 
                    <div class="credit-info">
                        <div class="credit-name">${credit.name}</div>
                        <div class="credit-details">C√≥digo: ${credit.id} ‚Ä¢ ${credit.details}</div>
                    </div>
                    <div class="credit-amount">Q${credit.amount}</div>
            </a>`;
                pendingList.appendChild(creditItem);
            });
        }

        // Cr√©ditos vigentes
        if (creditosData.currentLoans.length === 0) {
            vigenteList.innerHTML = '<div class="credit-item" style="text-align: center; color: #6c757d;">No hay cr√©ditos vigentes</div>';
        } else {
            creditosData.currentLoans.forEach(credit => {
                const creditItem = document.createElement('div');
                creditItem.className = 'credit-item';
                creditItem.innerHTML = `
            <a href='/financings/credit/${credit._id}/' style='text-decoration:none;'> 
                    <div class="credit-info">
                        <div class="credit-name">${credit.name}</div>
                        <div class="credit-details">C√≥digo: ${credit.id} ‚Ä¢ ${credit.details}</div>
                    </div>
                    <div class="credit-amount">Q${credit.amount}</div>
            </a>`;
                vigenteList.appendChild(creditItem);
            });
        }
    }

    function openModal() {
        const modal = document.getElementById('m_modal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
    function openModalVigentes() {
        const modal = document.getElementById('m_modal_vigente');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        const modal = document.getElementById('m_modal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    function closeModalVigente() {
        const modal = document.getElementById('m_modal_vigente');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    // Cerrar modal al hacer clic fuera de √©l
    window.onclick = function (event) {
        const modal = document.getElementById('m_modal');
        const modal_vigente = document.getElementById('m_modal_vigente');
        if (event.target === modal) {
            closeModal();
        }
        if (event.target === modal_vigente) {
            closeModalVigente();
        }
    }

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeModal();
            closeModalVigente();
        }
    });

    // Funci√≥n que recibe los datos de la API y actualiza el widget
    function actualizarDatos(completed, pending, total_creditos, pendingCredits, currentLoans) {
        creditosData.completed = completed;
        creditosData.pending = pending;
        creditosData.total = total_creditos;
        creditosData.pendingCredits = pendingCredits;
        creditosData.currentLoans = currentLoans;

        updateWidgetData();
        loadPendingCredits();
    }

    // Funci√≥n opcional para refrescar los datos manualmente
    function refreshData() {
        const userCode = "{{ user_code }}";
        const apiUrl = `/customers/asesores_credito/api/${userCode}/`;

        showLoadingState();

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                actualizarDatos(
                    data.total_realizados,
                    data.total_faltantes,
                    data.total_creditos,
                    data.creditos_faltantes.map(c => ({
                        name: `${c.customer_id.first_name} ${c.customer_id.last_name}`,
                        amount: `${parseFloat(c.saldo_actual).toLocaleString()}`,
                        details: `Vencimiento: ${c.fecha_vencimiento}`,
                        id: c.codigo_credito
                    })),

                );
                hideLoadingState();
            })
            .catch(error => {
                console.error("Error al refrescar datos:", error);
                showErrorState(error.message);
            });
    }
</script>